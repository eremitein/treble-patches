From 1cca3ffb87eab373c1e193c7c3edcea58764faa1 Mon Sep 17 00:00:00 2001
From: Victor Bo <bvoid@yandex.ru>
Date: Wed, 30 Sep 2020 01:18:17 -0400
Subject: [PATCH 15/57] Revert "FODCircleView: Reduce calls for pressed icon
 state update"

This reverts commit 4bbe01c86aeaa4f6174f62450babcc4abea26784.
---
 .../systemui/biometrics/FODCircleView.java    | 37 +++++++++++--------
 1 file changed, 21 insertions(+), 16 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/biometrics/FODCircleView.java b/packages/SystemUI/src/com/android/systemui/biometrics/FODCircleView.java
index e9958c0b674..178662add44 100644
--- a/packages/SystemUI/src/com/android/systemui/biometrics/FODCircleView.java
+++ b/packages/SystemUI/src/com/android/systemui/biometrics/FODCircleView.java
@@ -115,7 +115,6 @@ public class FODCircleView extends ImageView implements ConfigurationListener {
     private int mDreamingOffsetY;
 
     private int mCurrentBrightness;
-    private int mPressedState;
 
     private boolean mIsBouncer;
     private boolean mIsDreaming;
@@ -278,12 +277,12 @@ public class FODCircleView extends ImageView implements ConfigurationListener {
             @Override
             protected void onDraw(Canvas canvas) {
                 if (mIsCircleShowing) {
-                    if (mPressedState == 0) {
-                        mPressedView.setImageResource(R.drawable.fod_icon_pressed);
-                    } else if (mPressedState == 1) {
-                        mPressedView.setImageResource(R.drawable.fod_icon_pressed_white);
-                    } else if (mPressedState == 2) {
-                        mPressedView.setImageDrawable(null);
+                    int fodstate = getFODPressedState();
+                    if (fodstate == 0) {
+                        setImageResource(R.drawable.fod_icon_pressed);
+                    } else if (fodstate == 1) {
+                        setImageResource(R.drawable.fod_icon_pressed_white);
+                    } else if (fodstate == 2) {
                         canvas.drawCircle(mSize / 2, mSize / 2, mSize / 2.0f, mPaintFingerprint);
                     }
                 }
@@ -331,9 +330,6 @@ public class FODCircleView extends ImageView implements ConfigurationListener {
             resolver.registerContentObserver(Settings.System.getUriFor(
                     Settings.System.SCREEN_BRIGHTNESS),
                     false, this, UserHandle.USER_ALL);
-            resolver.registerContentObserver(Settings.System.getUriFor(
-                    Settings.System.FOD_PRESSED_STATE),
-                    false, this, UserHandle.USER_ALL);
         }
 
         @Override
@@ -347,16 +343,12 @@ public class FODCircleView extends ImageView implements ConfigurationListener {
             } else if (uri.equals(Settings.System.getUriFor(
                     Settings.System.SCREEN_BRIGHTNESS))) {
                 updateIconDim();
-            } else if (uri.equals(Settings.System.getUriFor(
-                    Settings.System.FOD_PRESSED_STATE))) {
-                setFODPressedState();
             }
         }
 
         public void update() {
             updateStyle();
             updateIconDim();
-            setFODPressedState();
         }
     }
 
@@ -404,11 +396,23 @@ public class FODCircleView extends ImageView implements ConfigurationListener {
         super.onDraw(canvas);
     }
 
-    private void setFODPressedState() {
-        mPressedState = Settings.System.getInt(mContext.getContentResolver(),
+    private int getFODPressedState() {
+        return Settings.System.getInt(mContext.getContentResolver(),
                 Settings.System.FOD_PRESSED_STATE, 0);
     }
 
+    private void setFODPressedState() {
+        int fodpressed = getFODPressedState();
+
+        if (fodpressed == 0) {
+            setImageResource(R.drawable.fod_icon_pressed);
+        } else if (fodpressed == 1) {
+            setImageResource(R.drawable.fod_icon_pressed_white);
+        } else if (fodpressed == 2) {
+            setImageDrawable(null);
+        }
+    }
+
     @Override
     public boolean onTouchEvent(MotionEvent event) {
         float x = event.getAxisValue(MotionEvent.AXIS_X);
@@ -505,6 +509,7 @@ public class FODCircleView extends ImageView implements ConfigurationListener {
         setDim(true);
         dispatchPress();
 
+        setFODPressedState();
         updatePosition();
         updateIconDim();
         invalidate();
-- 
2.17.1

