From c43fc9cdeb2a41da244279ec86473e9504f4311b Mon Sep 17 00:00:00 2001
From: Pierre-Hugues Husson <phh@phh.me>
Date: Mon, 25 May 2020 21:25:12 +0200
Subject: [PATCH 3/3] Add persist.sys.phh.disable_a2dp_offload property to
 force a2dp offload

---
 btif/src/btif_av.cc             | 7 ++++++-
 stack/a2dp/a2dp_codec_config.cc | 7 ++++++-
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/btif/src/btif_av.cc b/btif/src/btif_av.cc
index 24e32ec10..fa537ba4e 100644
--- a/btif/src/btif_av.cc
+++ b/btif/src/btif_av.cc
@@ -959,9 +959,14 @@ bt_status_t BtifAvSource::Init(
   osi_property_get("ro.bluetooth.a2dp_offload.supported", value_sup, "false");
   osi_property_get("persist.bluetooth.a2dp_offload.disabled", value_dis,
                    "false");
+  char value_phh[PROPERTY_VALUE_MAX] = {'\0'};
+  osi_property_get("persist.sys.phh.disable_a2dp_offload", value_phh, "false");
   a2dp_offload_enabled_ =
       (strcmp(value_sup, "true") == 0) && (strcmp(value_dis, "false") == 0);
-  BTIF_TRACE_DEBUG("a2dp_offload.enable = %d", a2dp_offload_enabled_);
+  if(strcmp(value_phh, "true") == 0)
+      a2dp_offload_enabled_ = false;
+
+  LOG_ERROR(LOG_TAG, "a2dp_offload.enable = %s", a2dp_offload_enabled_ ? "on" : "off");
 
   callbacks_ = callbacks;
   bta_av_co_init(codec_priorities);
diff --git a/stack/a2dp/a2dp_codec_config.cc b/stack/a2dp/a2dp_codec_config.cc
index edf7e0c46..143eed7a3 100644
--- a/stack/a2dp/a2dp_codec_config.cc
+++ b/stack/a2dp/a2dp_codec_config.cc
@@ -560,13 +560,18 @@ bool A2dpCodecs::init() {
   char* tok = NULL;
   char* tmp_token = NULL;
   bool offload_codec_support[BTAV_A2DP_CODEC_INDEX_MAX] = {false};
-  char value_sup[PROPERTY_VALUE_MAX], value_dis[PROPERTY_VALUE_MAX];
+  char value_sup[PROPERTY_VALUE_MAX], value_dis[PROPERTY_VALUE_MAX], value_phh[PROPERTY_VALUE_MAX];
 
   osi_property_get("ro.bluetooth.a2dp_offload.supported", value_sup, "false");
   osi_property_get("persist.bluetooth.a2dp_offload.disabled", value_dis,
                    "false");
+  osi_property_get("persist.sys.phh.disable_a2dp_offload", value_phh, "false");
   a2dp_offload_status =
       (strcmp(value_sup, "true") == 0) && (strcmp(value_dis, "false") == 0);
+  if(strcmp(value_phh, "true") == 0)
+      a2dp_offload_status = false;
+
+  LOG_ERROR(LOG_TAG, "Got a2dp offload status %s", a2dp_offload_status ? "on" : "off");
 
   if (a2dp_offload_status) {
     char value_cap[PROPERTY_VALUE_MAX];
-- 
2.17.1

